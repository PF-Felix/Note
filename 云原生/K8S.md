# ğŸ¥‡æ ¸å¿ƒæ¦‚å¿µ

## å„ç§å®¹å™¨ç¼–æ’å·¥å…·

**Docker Compose**
æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨çš„å·¥å…·ï¼Œä½¿ç”¨ YAML ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨ä¸€ä¸ªå‘½ä»¤å°±å¯ä»¥æ ¹æ®é…ç½®åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
å±€é™æ˜¯é€‚åˆäºå•ä¸»æœºï¼Œä¸é€‚ç”¨å¤šä¸»æœºåˆ†å¸ƒå¼é›†ç¾¤ç¯å¢ƒ

**Docker Swarm**
å†…ç½®äº Dockerï¼Œå¯ä»¥è¿›è¡Œé›†ç¾¤çº§åˆ«çš„ç®¡ç†ï¼Œä½¿ç”¨ YAML ä½œä¸ºé…ç½®æ–‡ä»¶
æœåŠ¡è§„æ¨¡å¯æ‰©å¤§å¯ç¼©å°ï¼Œæ”¯æŒæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æ»šåŠ¨æ›´æ–°
2019å¹´é˜¿é‡Œäº‘å®£å¸ƒå¼ƒç”¨

**Mesos+Marathon**
Mesos æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…æ ¸çš„å¼€æºé›†ç¾¤ç®¡ç†å™¨ï¼ŒMarathon æ˜¯ä¸€ä¸ªåŸºäºå®¹å™¨çš„åº”ç”¨ç¨‹åºçš„ç¼–æ’æ¡†æ¶
Mesos èƒ½å¤Ÿåœ¨åŒæ ·çš„é›†ç¾¤æœºå™¨ä¸Šè¿è¡Œå¤šç§åˆ†å¸ƒå¼ç³»ç»Ÿç±»å‹ï¼Œå¯ä»¥æ›´åŠ åŠ¨æ€é«˜æ•ˆçš„å…±äº«èµ„æº
Mesos æä¾›æœåŠ¡å¤±è´¥æ£€æŸ¥ã€æœåŠ¡å‘å¸ƒã€æœåŠ¡ä¼¸ç¼©ã€æœåŠ¡è·Ÿè¸ªã€æœåŠ¡ç›‘æ§ã€èµ„æºç®¡ç†ã€èµ„æºå…±äº«
Mesos å¯ä»¥æ‰©å±•ä¼¸ç¼©åˆ°æ•°åƒä¸ªèŠ‚ç‚¹ï¼Œé€‚åˆäºå¦‚æœä½ æ‹¥æœ‰å¾ˆå¤šçš„æœåŠ¡å™¨è€Œä¸”æƒ³æ„å»ºä¸€ä¸ªå¤§çš„é›†ç¾¤çš„æ—¶å€™
ä½†æ˜¯å¤§è€Œå…¨ï¼Œå¾€å¾€å°±æ˜¯å¯¹åº”çš„å¤æ‚å’Œå›°éš¾ï¼Œä½¿ç”¨æˆ·å¿«é€Ÿå­¦ä¹ åº”ç”¨å˜å¾—æ›´åŠ å›°éš¾
2019å¹´ Twitter å®£å¸ƒå¼ƒç”¨

**kubernetes**
ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨å˜å¾—ç®€å•ä¸”é«˜æ•ˆï¼Œæä¾›äº†åº”ç”¨éƒ¨ç½²ã€è§„åˆ’ã€æ›´æ–°ã€ç»´æŠ¤ä¸€æ•´å¥—å®Œæ•´çš„æœºåˆ¶
é™¤äº† Docker ä¹‹å¤–è¿˜æ”¯æŒå…¶ä»–å¤šç§å®¹å™¨ï¼Œå¦‚ Containerdã€rktã€CoreOS ç­‰
å¯ä»¥å®ç°å®¹å™¨è°ƒåº¦ã€èµ„æºç®¡ç†ã€æœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨ä¼¸ç¼©ã€æ›´æ–°å‡çº§

ä¼˜ç‚¹ï¼šå®¹å™¨ç¼–æ’ã€è½»é‡çº§ã€å¼€æºã€å¿«é€Ÿéƒ¨ç½²ã€å¼¹æ€§ä¼¸ç¼©ã€è´Ÿè½½å‡è¡¡ã€è‡ªåŠ¨éƒ¨ç½²ã€è‡ªåŠ¨é‡å¯ã€è‡ªåŠ¨ä¼¸ç¼©

## èŠ‚ç‚¹

**masterèŠ‚ç‚¹**
K8Sé›†ç¾¤çš„ç®¡ç†èŠ‚ç‚¹ï¼Œæä¾›é›†ç¾¤çš„èµ„æºè®¿é—®å…¥å£
å¯ä»¥æ‹¥æœ‰åˆ†å¸ƒå¼é«˜å¯ç”¨çš„ etcd å­˜å‚¨æœåŠ¡ï¼Œè¿è¡Œäº† ApiServerã€Schedulerã€ControllerManager æœåŠ¡

**workerèŠ‚ç‚¹**
ä¹Ÿå« node èŠ‚ç‚¹ï¼Œæ˜¯è¿è¡Œ Pod æœåŠ¡çš„èŠ‚ç‚¹ã€è¿è¡Œå®ˆæŠ¤è¿›ç¨‹ Kubeletã€è´Ÿè½½å‡è¡¡å™¨ kube-proxy

## ç»„ä»¶

**ApiServer**
K8sé›†ç¾¤å†…éƒ¨å„åŠŸèƒ½æ¨¡å—çš„é€šä¿¡ï¼ˆmasterèŠ‚ç‚¹ï¼‰

**Scheduler**
è´Ÿè´£é›†ç¾¤èµ„æºè°ƒåº¦ï¼Œå°† Pod è°ƒåº¦åˆ°ç›¸åº”çš„ node èŠ‚ç‚¹ä¸Šï¼ˆmasterèŠ‚ç‚¹ï¼‰

**ControllerManager**
ç»´æŠ¤é›†ç¾¤çŠ¶æ€ï¼Œæ¯”å¦‚ç¨‹åºéƒ¨ç½²å®‰æ’ã€æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ï¼ˆmasterèŠ‚ç‚¹ï¼‰

**Etcd**
åˆ†å¸ƒå¼æ•°æ®åº“ï¼ˆmasterèŠ‚ç‚¹ï¼‰

**Kubelet**
workerèŠ‚ç‚¹
å‘ apiserver æ³¨å†ŒèŠ‚ç‚¹è‡ªèº«ä¿¡æ¯ï¼Œå¤„ç† apiserver ä¸‹å‘åˆ°æœ¬èŠ‚ç‚¹çš„æŒ‡ä»¤ï¼Œç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®šæœŸå‘ master æ±‡æŠ¥èŠ‚ç‚¹èµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ˆä½¿ç”¨ cAdvisor ç›‘æ§èŠ‚ç‚¹èµ„æºï¼‰

**kubectl**
æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥æ§åˆ¶K8Sé›†ç¾¤ç®¡ç†å™¨ï¼Œå¦‚æŸ¥çœ‹èµ„æºï¼Œåˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°ç»„ä»¶ï¼ˆmasterèŠ‚ç‚¹ï¼‰

**kube-proxy**
æ˜¯Serviceçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå°†æŸä¸ªServiceçš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¤šä¸ªPodå®ä¾‹ä¸Šï¼ˆworkerèŠ‚ç‚¹ï¼‰

## kubectlå¸¸ç”¨å‘½ä»¤

`kubectl -h`æŸ¥çœ‹å¸®åŠ©
![](829e67048981a0d55a2c7ce7e59edc15.png)
![](3b1e0e79e1f92a9789a179690c23cdd0.png)

```shell
#æŸ¥çœ‹èµ„æºæ”¯æŒçš„ç‰ˆæœ¬
kubectl api-resources | grep deployment
kubectl api-resources | grep pod
kubectl api-resources | grep service

#æŸ¥çœ‹èµ„æºè¯¦ç»†ä¿¡æ¯
kubectl describe ns kube-system
kubectl describe pod nginx1
kubectl describe node master1

########################## Namespace ##############################
#åˆ›å»º/åˆ é™¤namespaceï¼Œåˆ é™¤ä¼šåˆ é™¤å…¶ä¸‹æ‰€æœ‰çš„èµ„æº
kubectl create/delete namespace test

#æŸ¥çœ‹æ‰€æœ‰namespace
kubectl get namespace/ns

#æŸ¥çœ‹å‘½åç©ºé—´kube-systemä¸‹çš„èµ„æº
kubectl get all -n kube-system
kubectl get pods/pod -n kube-system
kubectl get pods/pod -n kube-system -o wide
kubectl get services/service/svc -n kube-system

########################## Pod ##############################
#åˆ›å»ºpod
kubectl run nginx1 --image=nginx
kubectl run nginx1 --image=nginx:1.15 -n test
kubectl apply -f xxx.yml
#åˆ é™¤pod
kubectl delete pod pod1 pod2 pod3
kubectl delete -f xxx.yml

#åœ¨å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœä¸æŒ‡å®šå®¹å™¨é»˜è®¤æ˜¯Podä¸­çš„ç¬¬ä¸€ä¸ª
kubectl exec -it pod-nginx1 -n tt -- ls
kubectl exec -it pod-nginx1 -n tt -- hostname
kubectl exec -it pod-nginx1 -n tt -c c2 -- hostname

#è¿›å…¥å®¹å™¨
kubectl exec -it pod-nginx1 -n tt bash

########################## Controller ##############################
#åˆ é™¤deployment
kubectl delete deployment deploy-nginx1

#ç‰ˆæœ¬å‡çº§
kubectl set image deployment deploy-nginx1 c1=nginx:1.16 --record
#statefulsetç‹¬æœ‰çš„ï¼Œpartition=2è¡¨ç¤ºåªæœ‰ç¼–å·å¤§äºç­‰äº2çš„Podæ‰æ›´æ–°ï¼Œé»˜è®¤partition=0
kubectl patch sts web -p '{"spec":{"updateStrategy":{"rollingUpdate":{"partition":2}}}}'
kubectl set image sts statefulset-nginx1 c1=nginx:1.16 --record

#æ‰©å®¹ç¼©å®¹
kubectl scale deployment deploy-nginx1 --replicas=2
kubectl scale sts statefulset-nginx1 --replicas=10

########################## Label ##############################
#æŸ¥çœ‹èµ„æºæ ‡ç­¾ä¿¡æ¯
kubectl get node --show-labels

#ç»™èµ„æºæ‰“æ ‡ç­¾
kubectl label node worker1 region=huanai env=test
kubectl label node worker1 region=huanai env=test --overwrite=true

#åˆ é™¤æ ‡ç­¾
kubectl label node worker1 region-

#æŸ¥çœ‹èµ„æºï¼Œæ ‡ç­¾è¿‡æ»¤
kubectl get node -l kubernetes.io/hostname=worker2
```

## Namespace

å‘½åç©ºé—´ï¼Œç”¨ä½œèµ„æºéš”ç¦»
å¸¸è§çš„èµ„æºæ¯”å¦‚ podã€serviceã€deployment éƒ½æ˜¯å±äºæŸä¸€ä¸ª namespace çš„

## Pod

Pod æ˜¯ K8S ä¸­ ä¸­æœ€å°çš„è®¡ç®—å•å…ƒï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œå®¹å™¨ä¸­è¿è¡Œç€åº”ç”¨ç¨‹åº
Pod çš„ IP ä¸æ˜¯å›ºå®šçš„ï¼Œé›†ç¾¤å¤–ä¸èƒ½ç›´æ¥è®¿é—®
åŒä¸€ä¸ª Pod ä¸­æ‰€æœ‰å®¹å™¨ç½‘ç»œå…±äº«

**YMLåˆ›å»ºPod**

```yaml
apiVersion: v1
kind: Pod                  #èµ„æºç±»å‹
metadata:                  #æ•°æ®å…ƒ
  name: pod-nginx1         #èµ„æºå
  namespace: tt            #å‘½åç©ºé—´ï¼Œé»˜è®¤æ˜¯default
  labels:                  #æ ‡ç­¾
    env: dev
    sex: man
spec:
  containers:              #å®¹å™¨
    - name: c1
      image: nginx:1.15    #é•œåƒ
```

**èµ„æºé™åˆ¶**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-stress1
  namespace: tt
spec:
  containers:
    - name: c1
      image: polinux/stress
      resources:
        limits:
          memory: "200Mi"
        requests:
          memory: "150Mi"
      command: ["stress"]  #å¯åŠ¨å®¹å™¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
      #ç”Ÿæˆä¸€ä¸ªè¿›ç¨‹åˆ†é…150Må†…å­˜1ç§’åé‡Šæ”¾
      args: ["--vm", "1", "--vm-bytes", "250M", "--vm-hang", "1"]
```

è¿™ä¸ªé‡å¯æ˜¯æ— æ³•å¯åŠ¨çš„ï¼Œå¦‚æœæŠŠ 250 æ”¹ä¸º 100 å°±å¯ä»¥æˆåŠŸå¯åŠ¨äº†

**éƒ¨ç½²åˆ°ç‰¹å®šNode**

`spec.nodeName`å®šä¹‰ä¸»æœºåå¯ä»¥å°† pod éƒ¨ç½²åˆ°ç‰¹å®šçš„ node
`spec.nodeSelector`å®šä¹‰ä¸€äº›æ ‡ç­¾ç”¨äºå°† pod è°ƒåº¦åˆ°åŒ¹é…æ ‡ç­¾çš„ node

**æ¢é’ˆ**

| æ£€æŸ¥æ–¹å¼ | |
| --- | --- |
| exec | æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›ç æ˜¯0è¡¨ç¤ºå¥åº· |
| httpget | è¯·æ±‚æŸä¸ªURLï¼Œå“åº”ç æ˜¯ 2XX or 3XX è¡¨ç¤ºå¥åº· |
| tcp | è¿æ¥æŸä¸ªç«¯å£ï¼Œè‹¥èƒ½å»ºç«‹è¿æ¥è¡¨ç¤ºå¥åº· |

| æ¢é’ˆç§ç±» |  |
| ---- | ---- |
| liveness | å¦‚æœæ¢æµ‹å¤±è´¥ï¼Œå®¹å™¨å°†è¢«æ€æ­» |
| readiness | å¦‚æœæ¢æµ‹å¤±è´¥ï¼Œä¸ pod åŒ¹é…çš„æœåŠ¡çš„ç«¯ç‚¹åˆ—è¡¨å°†åˆ é™¤è¿™ä¸ª pod çš„ IP |
| startup | å¦‚æœæä¾›äº†æ­¤æ¢é’ˆï¼Œå…¶ä»–æ¢é’ˆæš‚æ—¶ç¦ç”¨ï¼Œç›´åˆ°æ­¤æ¢é’ˆæˆåŠŸï¼›å¦‚æœæ¢æµ‹å¤±è´¥ï¼Œå®¹å™¨å°†è¢«æ€æ­» |
|  |  |

~~liveness-exec~~

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-exec
spec:
  containers:
  - name: c1
    image: nginx:1.15
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5    #podå¯åŠ¨å»¶è¿Ÿ5ç§’åæ¢æµ‹
      periodSeconds: 5          #æ¯5ç§’æ¢æµ‹1æ¬¡

```

`watch kubectl get pods`

~~liveness-httpget~~

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-httpget
spec:
  containers:
  - name: c1
    image: nginx:1.15
    livenessProbe:
      httpGet:
        port: 80
        path: /
      initialDelaySeconds: 5
      periodSeconds: 5
```

`watch kubectl get pods`ç›‘æ§çŠ¶æ€ä¸é‡å¯æ¬¡æ•°
`kubectl exec -it pod-liveness-httpget -- rm -rf /usr/share/nginx/html/index.html`åˆ é™¤è¿™ä¸ªæ–‡ä»¶åå‘ç° Pod é‡å¯äº†ä¸€æ¬¡

~~liveness-tcp~~

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-tcp
spec:
  containers:
  - name: c1
    image: nginx:1.15
    livenessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
```

ç›‘æ§é‡å¯æ¬¡æ•°
`kubectl exec -it pod-liveness-tcp -- /usr/sbin/nginx -s stop`åœæ‰ nginx ä¹‹å Pod é‡å¯ä¸€æ¬¡

**postStart&preStop**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-poststart
spec:
  containers:
  - name: c1
    image: nginx:1.15
    lifecycle:
      postStart:
        exec:
          command:
          - mkdir
          - -p
          - /tmp/xxx
```

æ£€æŸ¥ xxx ç›®å½•æ˜¯å¦å­˜åœ¨`kubectl exec -it pod-poststart -- ls /tmp`

## Controller

æ§åˆ¶å™¨ç®¡ç†å’Œè¿è¡Œ Podï¼Œä¸ Pod é€šè¿‡æ ‡ç­¾å»ºç«‹å…³ç³»
æ§åˆ¶å™¨ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼Œè‡´åŠ›äºå°†å½“å‰çŠ¶æ€è½¬å˜ä¸ºæœŸæœ›çŠ¶æ€ï¼Œæ¯”å¦‚åˆ é™¤ Pod é©¬ä¸Šå°±æœ‰æ–° Pod åˆ›å»ºå‡ºæ¥
å¦‚æœæ§åˆ¶å™¨è¢«åˆ é™¤ï¼Œç›¸å…³çš„ replicasetã€serviceã€pod ä¹Ÿå°†è‡ªåŠ¨åˆ é™¤
å›  Pod éƒ½åœ¨åŒç½‘æ®µï¼Œå› æ­¤å¯ä»¥é€šè¿‡ ip äº’ç›¸é€šä¿¡

### Deployment

åŒ…å«äº† ReplicaSet
æ”¯æŒæ‰©å®¹ç¼©å®¹ï¼ŒæŸ¥çœ‹ã€Šå¸¸ç”¨å‘½ä»¤ã€‹ï¼Œå…³æ³¨ Pod çš„æ•°é‡å˜åŒ–
æ”¯æŒå‡çº§ç‰ˆæœ¬ï¼ŒæŸ¥çœ‹ã€Šå¸¸ç”¨å‘½ä»¤ã€‹ï¼Œå…ˆå‡çº§ä¸€éƒ¨åˆ†å†å‡çº§ä¸€éƒ¨åˆ†ï¼Œæ»šåŠ¨æ›´æ–°ï¼Œé»˜è®¤çš„å‡çº§ç­–ç•¥
åˆ é™¤ Pod é©¬ä¸Šå°±èƒ½çœ‹åˆ°åˆä¸€ä¸ª Pod è¢«åˆ›å»ºå‡ºæ¥ï¼Œå…ˆåˆ›å»ºå†åˆ é™¤

éƒ¨ç½²çš„æ˜¯æ— çŠ¶æ€åº”ç”¨
1ã€æ‰€æœ‰ Pod æ— å·®åˆ«ã€æ— é¡ºåºä¹‹åˆ†ã€å‘½åæ— è§„åˆ™
2ã€æ•°æ®æŒä¹…åŒ–ï¼šæ‰€æœ‰ Pod å…±äº«å­˜å‚¨
3ã€Pod ä¹‹é—´æ— éœ€é€šä¿¡ï¼›Pod åç§°éšæœºIPéšæœºå› æ­¤åšä¸åˆ°ç¨³å®šé€šä¿¡ï¼ˆå¯ä»¥é€šè¿‡IPé€šä¿¡å› ä¸ºéƒ½åœ¨åŒç½‘æ®µï¼‰

**éƒ¨ç½²**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-nginx1
spec:
  replicas: 1          #å‰¯æœ¬æ•°é‡å³podçš„æ•°é‡ï¼Œdeploymenté»˜è®¤ç”¨äº†replicaset
  selector:
    matchLabels:
      env: dev         #è¡¨ç¤ºdeploymentå’Œæ§åˆ¶å™¨åŒ¹é…å¸¦æœ‰æ­¤æ ‡ç­¾çš„pod
  template:            #podçš„é…ç½®æ¨¡æ¿
    metadata:
      name: pod-nginx1
      labels:
        env: dev
    spec:
      containers:
      - name: c1
        image: nginx:1.15
```

éƒ¨ç½²ä¹‹åæŸ¥çœ‹å¦‚ä¸‹å›¾ï¼š
![](db3f73f039f2f0b40d7c200f7cd3a5ad.png)

åœ¨ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ curl PodIP éƒ½èƒ½è®¿é—®åˆ° nginx çš„é»˜è®¤é¡µé¢ï¼Œä½†åœ¨å¤–ç½‘ï¼ˆæ¯”å¦‚å®¿ä¸»æœºï¼‰å°±æ— æ³•è®¿é—®

### StatefulSet

**åŒ Deployment ç›¸æ¯”**
æ”¯æŒæ‰©å®¹ç¼©å®¹ï¼ŒæŸ¥çœ‹ã€Šå¸¸ç”¨å‘½ä»¤ã€‹
æ”¯æŒç‰ˆæœ¬å‡çº§ï¼ŒæŸ¥çœ‹ã€Šå¸¸ç”¨å‘½ä»¤ã€‹ï¼Œä¸åŒç‚¹æ˜¯ deploy ä¸€æ¬¡æ€§å…¨å‡çº§ï¼Œstatefulset æ”¯æŒç°åº¦å‘å¸ƒåªå‡çº§ä¸€éƒ¨åˆ†
åˆ é™¤ Pod é©¬ä¸Šå°±èƒ½çœ‹åˆ°åˆä¸€ä¸ª Pod è¢«åˆ›å»ºå‡ºæ¥ï¼ˆåç§°ç­‰ä¸å˜ï¼‰ï¼Œå…ˆåˆ é™¤å†åˆ›å»º

éƒ¨ç½²çš„æ˜¯æœ‰çŠ¶æ€åº”ç”¨ï¼š
1ã€Pod æ˜¯æœ‰åºçš„ã€å‘½åæœ‰è§„åˆ™ä¸”åç§°å›ºå®šä¸å˜
2ã€æ•°æ®æŒä¹…åŒ–ï¼šæ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„å­˜å‚¨ä¿å­˜æ•°æ®ï¼Œé€šè¿‡ volumeClaimTemplates å®ç°
3ã€Pod ä¹‹é—´æœ‰å¯èƒ½éœ€è¦é€šä¿¡ï¼ŒPod IPéšæœºä½†åç§°å›ºå®šï¼ŒDNSå¯ä»¥å°†åç§°è§£æä¸ºIPï¼Œå› æ­¤å¯ä»¥ç¨³å®šé€šä¿¡

**éƒ¨ç½²**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  ports:
  - port: 80
    name: web
  clusterIP: None
  selector:
    app: nginx
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  selector:
    matchLabels:
      app: nginx
  serviceName: "nginx"
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
        - containerPort: 80
          name: web
        volumeMounts:
        - name: disk-ssd
          mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: disk-ssd
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "nfs-client"
      resources:
        requests:
          storage: 20Gi
```

### DaemonSet

é›†ç¾¤ä¸­æ¯ä¸ª worker éƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ª podï¼Œå› æ­¤æ²¡æœ‰ replicas å­—æ®µï¼Œä¸”ä¸æ”¯æŒæ‰©å®¹ç¼©å®¹
å½“æœ‰ worker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œpod å°±è¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼›èŠ‚ç‚¹ä»é›†ç¾¤ç§»é™¤ï¼Œè¯¥èŠ‚ç‚¹çš„ pod å°†è¢«åˆ é™¤
å¯ä»¥ç†è§£ä¸ºæ˜¯ç‰¹æ®Šçš„ deployment

### Job

å¯¹äºéè€ä¹…æ€§ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåï¼Œpod éœ€è¦ç»“æŸè¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ç”¨åˆ° Job

**ä¸€ä¸ªç®€å•ä¾‹å­**

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: job-nginx1
spec:
  completions: 10                               #æ‰§è¡Œjobçš„æ¬¡æ•°
  parallelism: 1                                #æ‰§è¡Œjobçš„å¹¶å‘æ•°
  template:
    metadata:
      name: pod-nginx1
    spec:
      containers:
      - name: c1
        image: nginx:1.15
        command: ["echo", "xxx"]
      restartPolicy: Never
```

![](4fb7587f0c157d1c4d0aeb77b16636d8.png)

### CronJob

å®šæœŸæ‰§è¡Œä»»åŠ¡

**ä¸€ä¸ªç®€å•ä¾‹å­**

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob-nginx1
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          name: pod-nginx1
        spec:
          containers:
          - name: c1
            image: nginx:1.15
            command: ["echo", "xxx"]
          restartPolicy: Never
```

æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡

## Service

- Pod ç»å¸¸ç”¨åå³ç„šï¼ŒIPåœ°å€ç»å¸¸å˜åŒ–ï¼Œæ— æ³•ç¨³å®šç›´æ¥è®¿é—® Pod æä¾›çš„æœåŠ¡ï¼Œäºæ˜¯æœ‰äº† Service
- Service æŠŠ Pod çš„ IPåœ°å€åŠ å…¥ç«¯ç‚¹åˆ—è¡¨ï¼ˆEndpointsï¼‰ï¼Œé€šè¿‡ Service ä»£ç†è®¿é—® Pod
- Service å’Œ Pod é€šè¿‡æ ‡ç­¾å…³è”ï¼ŒService é€šè¿‡æ ‡ç­¾æ„ŸçŸ¥ Pod IPåœ°å€çš„å˜åŒ–

Pod é€šè¿‡ Service å®ç°**è´Ÿè½½å‡è¡¡**ï¼Œåº•å±‚å®ç°æ˜¯ kube-proxy æä¾›çš„**ä»£ç†æ¨¡å¼**ï¼Œæœ‰ä¸‰ç§
1. ~~userspace~~ç¬¬ä¸€ä»£ï¼Œæ€§èƒ½ä¸é«˜ä¸æ¨èä½¿ç”¨äº†
2. ~~iptables~~ç¬¬äºŒä»£ï¼Œæ¯”ç¬¬ä¸€ä»£æ€§èƒ½é«˜
    1. åŸç†ï¼šé€šè¿‡ apiserver çš„ watch æ¥å£å®æ—¶è·Ÿè¸ª service ä¸ Endpoint çš„å˜æ›´ä¿¡æ¯ï¼Œå¹¶æ›´æ–°å¯¹åº”çš„iptables è§„åˆ™ï¼Œè¯·æ±‚é€šè¿‡ iptables çš„ NAT æœºåˆ¶è·¯ç”±åˆ°ç›®æ ‡ Pod
3. ~~ipvs~~ä¸“é—¨ç”¨äºé«˜æ€§èƒ½è´Ÿè½½å‡è¡¡ï¼Œç¬¬ä¸‰ä»£ä¼˜äºç¬¬äºŒä»£ï¼Œç¼ºç‚¹æ˜¯ä½ç‰ˆæœ¬çš„å†…æ ¸æ— æ³•ä½¿ç”¨
    1. åŸç†ï¼šä½¿ç”¨ iptables çš„æ‰©å±• ipsetï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ iptables æ¥ç”Ÿæˆè§„åˆ™é“¾ã€‚iptables è§„åˆ™é“¾æ˜¯ä¸€ä¸ªçº¿æ€§çš„æ•°æ®ç»“æ„ï¼Œipset åˆ™å¼•å…¥äº†å¸¦ç´¢å¼•çš„æ•°æ®ç»“æ„ï¼Œå› æ­¤å½“è§„åˆ™å¾ˆå¤šæ—¶ï¼Œä¹Ÿå¯ä»¥å¾ˆé«˜æ•ˆåœ°æŸ¥æ‰¾å’ŒåŒ¹é…
4. 1.10ç‰ˆæœ¬å‰ç”¨ iptables
5. 1.11ç‰ˆæœ¬åå¯åŒæ—¶ç”¨ iptablesã€ipvsï¼Œé»˜è®¤ipvsï¼Œå¦‚æœipvsæ²¡æœ‰åŠ è½½ï¼Œä¼šè‡ªåŠ¨é™çº§è‡³iptables

service æœ‰ä¸‹é¢å‡ ç§ç±»å‹ï¼š

### ClusterIP

æ™®é€šçš„ ClusterIP

```yaml
apiVersion: v1
kind: Service
metadata:
  name: sts-ip
spec:
  selector:
    env: dev
  ports:
  - port: 80
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sts-ip
spec:
  serviceName: sts-ip
  replicas: 3
  selector:
    matchLabels:
      env: dev
  template:
    metadata:
      name: pod
      labels:
        env: dev
    spec:
      containers:
      - name: c1
        image: nginx:1.15
```

æä¾›é›†ç¾¤å†…éƒ¨ï¼ˆPodï¼‰å¯ä»¥è®¿é—®çš„è™šæ‹ŸIPï¼Œé€šè¿‡ kube-proxy åšè´Ÿè½½å‡è¡¡è®¿é—®å„ä¸ª Podï¼ˆcurl clusterIPï¼‰
deployment æƒ…å†µä¸‹ï¼šPod çš„å…¨é™å®šåŸŸåå°±æ˜¯ Pod åç§°ï¼Œé€šè¿‡ hostname -f å‘½ä»¤æŸ¥çœ‹
statefulset æƒ…å†µä¸‹ï¼šPod çš„å…¨é™å®šåŸŸåä¸ç”¨ headless service æ˜¯ä¸€æ ·çš„

### Headless Service

æ²¡æœ‰IPï¼Œæä¾›å›ºå®šæœåŠ¡åï¼Œæ²¡æœ‰è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼ŒDNS å°†å…¶ç›´æ¥è§£æä¸º Pod IP åˆ—è¡¨ï¼Œå¯ç”¨åšæœåŠ¡å‘ç°
é›†ç¾¤å†…æ— æ³•è®¿é—®åˆ° pod

ä¸¾ä¾‹1ï¼šæ­é… deploymentï¼Œpod çš„å…¨é™å®šåŸŸåæ˜¯éšæœºçš„

```yaml
apiVersion: v1
kind: Service
metadata:
  name: deploy-headless
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    env: dev
  ports:
  - port: 8080
    targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-headless
spec:
  replicas: 3
  selector:
    matchLabels:
      env: dev
  template:
    metadata:
      name: busybox
      labels:
        env: dev
    spec:
      containers:
      - name: c1
        image: busybox:1.28.3
        command: ["/bin/sh", "-c", "tail -f /dev/null"]
```

![](b04175fe91c80943141f3fb0f672e084.png)

ä¸¾ä¾‹2ï¼šæ­é… statefulsetï¼Œpod çš„å…¨é™å®šåŸŸåæ˜¯å›ºå®šä¸å˜çš„

```yaml
apiVersion: v1
kind: Service
metadata:
  name: sts-headless
spec:
  clusterIP: None
  selector:
    env: dev
  ports:
  - port: 80
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sts-headless
spec:
  serviceName: sts-headless
  replicas: 3
  selector:
    matchLabels:
      env: dev
  template:
    metadata:
      name: pod
      labels:
        env: dev
    spec:
      containers:
      - name: c1
        image: busybox:1.28.3
        command: ["/bin/sh", "-c", "tail -f /dev/null"]

```

![](a8393b806712ef35a785b0d47bbc27f7.png)

### NodePort

```yaml
apiVersion: v1
kind: Service
metadata:
  name: deploy-nodeport
spec:
  type: NodePort
  selector:
    env: dev
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30001
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-nodeport
spec:
  replicas: 3
  selector:
    matchLabels:
      env: dev
  template:
    metadata:
      name: pod
      labels:
        env: dev
    spec:
      containers:
      - name: c1
        image: nginx:1.15
```

åœ¨ ClusterIP çš„åŸºç¡€ä¸Šï¼Œåœ¨æ¯ä¸ª Node ä¸Šåˆ†é…ä¸€ä¸ªç«¯å£ä½œä¸ºé›†ç¾¤è®¿é—®å…¥å£
é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ service
è€Œä¸”é›†ç¾¤å†…`curl 10.0.0.14:30001`å¯ä»¥è®¿é—®åˆ° Podï¼Œä¹Ÿæ”¯æŒè´Ÿè½½å‡è¡¡ï¼Œèƒ½å¤Ÿç»™å¤–ç½‘è®¿é—®äº†

### LoadBalance

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.15
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  ports:
  - port: 8090
    protocol: TCP
    targetPort: 80
  selector:
    app: nginx
  type: LoadBalancer
```

éœ€è¦æ­é…äº‘æœåŠ¡è´Ÿè½½å‡è¡¡å™¨
![](b7d604c3a0f913cdc6f9b76d15d898ce.png)

é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ serviceï¼Œè€Œä¸”å®ƒæ˜¯ä¸€ä¸ª NodePort Service åªä¸è¿‡ç«¯å£ä¸èƒ½æŒ‡å®š
ä½¿ç”¨å¤–æ¥è´Ÿè½½å‡è¡¡å™¨å®Œæˆåˆ°æœåŠ¡çš„åˆ†å‘ï¼Œéœ€è¦`spec.status.loadBalancer`æŒ‡å®šå¤–æ¥IPåœ°å€

### ExternalName

å¯ä»¥å°†é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡å¼•å…¥ï¼Œå®ç°äº†é›†ç¾¤å†…éƒ¨ Pod å’Œé›†ç¾¤å¤–éƒ¨æœåŠ¡é€šä¿¡

## Label

æ ‡ç­¾æ˜¯ä¸€ç»„ KVï¼Œå¯ä»¥é™„åŠ åˆ°å„ç§èµ„æºä¸Šå¦‚ nodeã€serviceã€podï¼Œç”¨äºå…³è”èµ„æº

```shell
#æŸ¥çœ‹Podçš„æ ‡ç­¾
kubectl get pods --show-labels -n kube-system

#æŸ¥çœ‹Podç”¨æ ‡ç­¾è¿‡æ»¤
kubectl get pods -n kube-system -l env=test
kubectl get pods -n kube-system -l "zone in (A,B,C)"

#ç»™Podæ‰“æ ‡ç­¾
kubectl label pod pod-nginx1 -n kube-system region=huanai zone=A env=test bussiness=game
```

## Ingress

Ingress ç”¨äºå°†ä¸åŒ URL çš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°åç«¯ä¸åŒçš„ Service
å…¥å£æ§åˆ¶å™¨æ¥æ”¶æ‰€æœ‰è®¿é—®è¯·æ±‚ï¼ŒåŸºäº Ingress è§„åˆ™ï¼Œå°†å®¢æˆ·ç«¯è¯·æ±‚ç›´æ¥è½¬å‘åˆ° Service å¯¹åº”çš„ Endpoint ä¸Šï¼Œä»è€Œè·³è¿‡ kube-proxy çš„è½¬å‘åŠŸèƒ½

## Ingressæœ€ä½³å®è·µ

```shell
#ä¸‹è½½ingress-nginxæ§åˆ¶å™¨
wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.0/deploy/static/provider/cloud/deploy.yaml

#ä¿®æ”¹service.type=NodePort 80ç«¯å£æš´éœ²çš„ç«¯å£ä¸º30080

#å¼€å¯
kubectl apply -f deploy.yaml

#æ‰©å®¹æˆäº”ä¸ª
kubectl scale deployment ingress-nginx-controller -n ingress-nginx --replicas=5

#æœ€ç»ˆå¥åº·çš„çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤º
```

![](1b23ef23a6e14f42481c5d59148739b6.png)

### ä¸€ä¸ªåº”ç”¨

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: ingress-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: c1
        image: nginx:1.15
        imagePullPolicy: IfNotPresent
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: ingress-nginx
  labels:
    app: nginx
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: nginx
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
    kubernetes.io/ingress.class: nginx
spec:
  rules:
  - host: www.kubemsb1.com
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: nginx-service
            port:
              number: 80
```

ä¸Šè¿°ä»£ç  apply ä¹‹åï¼Œå¾—åˆ°çš„çŠ¶æ€å¦‚ä¸‹å›¾

![](d01fafa4772abeeeb66e851f95797974.png)
![](c95b8dc3f97b5c3fa875c88450347972.png)

å…ˆéªŒè¯ service/nginx-service æ˜¯è´Ÿè½½å‡è¡¡çš„

![](738aa98258e2caad25bd8c1efe7e94f1.png)
![](c1ed23f546dd7aa2f4bf6429f735daa1.png)

å®¿ä¸»æœºè®¿é—®æµ‹è¯•ï¼Œä¹Ÿæ˜¯è´Ÿè½½å‡è¡¡

```shell
#é…ç½®hosts
10.0.0.14 www.kubemsb.com
10.0.0.15 www.kubemsb.com

#åˆ·æ–°DNSç¼“å­˜
ipconfig /flushdns
```

![](5e4af1eef6453f0496d36e0ddc99ac34.png)

### ä¸¤ä¸ªåº”ç”¨ä¸¤ä¸ªåŸŸå

åœ¨ä¸€ä¸ªåº”ç”¨çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¬¬äºŒä¸ªåº”ç”¨

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-1
  namespace: ingress-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-1
  template:
    metadata:
      labels:
        app: nginx-1
    spec:
      containers:
      - name: c1
        image: nginx:1.15
        imagePullPolicy: IfNotPresent
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service-1
  namespace: ingress-nginx
  labels:
    app: nginx-1
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: nginx-1
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-nginx-1
  namespace: ingress-nginx
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
    kubernetes.io/ingress.class: nginx
spec:
  rules:
  - host: www.kubemsb1.com
    http:
      paths:
      - pathType: Prefix
        path: "/"
        backend:
          service:
            name: nginx-service-1
            port:
              number: 80
```

![](10620502407f99d4e7b9a3b5793aba0d.png)
![](e916645338916804cd219088c834dbc9.png)

å®¿ä¸»æœºè®¿é—®æµ‹è¯•ï¼Œä¹Ÿæ˜¯è´Ÿè½½å‡è¡¡

```
#hosts
10.0.0.14 www.kubemsb.com
10.0.0.15 www.kubemsb.com
10.0.0.14 www.kubemsb1.com
10.0.0.15 www.kubemsb1.com
```

![](d6abb8a11bef5d66eb75619fca0c24b2.png)

### ä¸€ä¸ªåº”ç”¨ä¸¤ä¸ªURL

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-1
  namespace: ingress-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-1
  template:
    metadata:
      labels:
        app: nginx-1
    spec:
      containers:
      - name: c1
        image: nginx:1.15
        imagePullPolicy: IfNotPresent
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service-1
  namespace: ingress-nginx
  labels:
    app: nginx-1
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: nginx-1
```
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-2
  namespace: ingress-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-2
  template:
    metadata:
      labels:
        app: nginx-2
    spec:
      containers:
      - name: c1
        image: nginx:1.15
        imagePullPolicy: IfNotPresent
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service-2
  namespace: ingress-nginx
  labels:
    app: nginx-2
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: nginx-2
```
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
    kubernetes.io/ingress.class: nginx
spec:
  rules:
  - host: www.kubemsb.com
    http:
      paths:
      - pathType: Prefix
        path: "/svc1"
        backend:
          service:
            name: nginx-service-1
            port:
              number: 80
      - pathType: Prefix
        path: "/svc2"
        backend:
          service:
            name: nginx-service-2
            port:
              number: 80
```

å†åœ¨å››ä¸ª Pod ä¸­åšä¸‹é¢çš„æ“ä½œ
![](db92c9e74d172d4214b55cb25ad6b9cf.png)

ç„¶åè®¿é—®`http://www.kubemsb.com:30080/svc1`å’Œ`http://www.kubemsb.com:30080/svc2`å°±å¯ä»¥æŸ¥çœ‹è´Ÿè½½å‡è¡¡æ•ˆæœäº†

-----

å¦‚æœä½¿ç”¨ä¸Šé¢çš„`service.type=NodePort`çš„ ingress-nginx æ§åˆ¶å™¨ï¼Œåœ¨å‰é¢åŠ ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„ä»£ç†

# ğŸ¥‡é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²

> k8sç‰ˆæœ¬ï¼šv1.21

## ä¸»æœºè§„åˆ’

| è§’è‰²&ä¸»æœºå | IPåœ°å€ |
| --- | --- |
| master1 | 10.0.0.11 |
| master2 | 10.0.0.12 |
| master3 | 10.0.0.13 |
| worker1 | 10.0.0.14 |
| worker2 | 10.0.0.15 |
| LB1 | 10.0.0.16 |
| LB2 | 10.0.0.17 |
| node8 | 10.0.0.18 |
| VIP | 192.168.0.100 |
| Pod | 10.244.0.0/16 |
| Service | 10.96.0.0/12 |

## å‰ç½®å‡†å¤‡

### ä¸»æœºåä¸IPæ˜ å°„

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
10.0.0.11 master1
10.0.0.12 master2
10.0.0.13 master3
10.0.0.14 worker1
10.0.0.15 worker2
10.0.0.16 lb1
10.0.0.17 lb2
```

### å…³é—­é˜²ç«å¢™

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
systemctl disable firewalld
systemctl stop firewalld
firewall-cmd --state
```

### å…³é—­selinux

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
```

### å…³é—­äº¤æ¢åˆ†åŒº

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
vi /etc/fstab

#æŠŠä¸‹é¢è¿™è¡Œä»£ç æ³¨é‡Šæ‰
# /dev/mapper/centos-swap swap xxxxx

reboot
```

### æ—¶é—´åŒæ­¥

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
yum -y install ntpdate
ntpdate cn.pool.ntp.org | ntp[1-7].aliyun.com
```

### ç³»ç»Ÿä¼˜åŒ–

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
ulimit -SHn 65535

cat <<EOF >> /etc/security/limits.conf
* soft nofile 655360
* hard nofile 131072
* soft nproc 655350
* hard nproc 655350
* soft memlock unlimited
* hard memlock unlimited
EOF
```

### å†…æ ¸å‡çº§

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
#å¯¼å…¥elrepo gpg key
rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
#å®‰è£…elrepo YUMæºä»“åº“
yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm
#å®‰è£…kernel-mlç‰ˆæœ¬ï¼Œmlä¸ºé•¿æœŸç¨³å®šç‰ˆæœ¬ï¼Œltä¸ºé•¿æœŸç»´æŠ¤ç‰ˆæœ¬
yum --enablerepo="elrepo-kernel" -y install kernel-ml.x86_64
#è®¾ç½®grub2é»˜è®¤å¼•å¯¼ä¸º0
grub2-set-default 0
#é‡æ–°ç”Ÿæˆgrub2å¼•å¯¼æ–‡ä»¶
grub2-mkconfig -o /boot/grub2/grub.cfg

#é‡å¯åï¼Œéœ€è¦éªŒè¯å†…æ ¸æ˜¯å¦ä¸ºæ›´æ–°å¯¹åº”çš„ç‰ˆæœ¬
reboot
uname -r
```

### å†…æ ¸ä¼˜åŒ–

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
cat <<EOF > /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 131072
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF
```
```shell
sysctl --system
reboot
```

### ç¦ç”¨NetworkManager

> æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é…ç½®

```shell
systemctl stop NetworkManager
systemctl disable NetworkManager
```

### IPVSç®¡ç†å·¥å…·å®‰è£…åŠæ¨¡å—åŠ è½½

> æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹å®‰è£…ï¼Œè´Ÿè½½å‡è¡¡èŠ‚ç‚¹ä¸ç”¨å®‰è£…

```shell
yum -y install ipvsadm ipset sysstat conntrack libseccomp
```

```shell
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
EOF
```

```shell
cat >/etc/modules-load.d/ipvs.conf <<EOF
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF
```

```shell
#è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨
systemctl enable --now systemd-modules-load.service

#æˆæƒã€è¿è¡Œã€æ£€æŸ¥æ˜¯å¦åŠ è½½
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack
```

### å®‰è£…docker

> æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹å®‰è£…ï¼Œè´Ÿè½½å‡è¡¡èŠ‚ç‚¹ä¸ç”¨å®‰è£…

```shell
wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum -y install docker-ce
systemctl enable docker
systemctl start docker

vi /etc/docker/daemon.json
{
    "exec-opts": ["native.cgroupdriver=systemd"],
    "registry-mirrors": ["https://o4osh0q0.mirror.aliyuncs.com"]
}
systemctl daemon-reload
systemctl restart docker
```

### ä¼ è¾“æ–‡ä»¶å…å¯†

> åªåœ¨masterèŠ‚ç‚¹

```shell
ssh-keygen
ssh-copy-id root@master2
ssh-copy-id root@master3
ssh-copy-id root@worker1
ssh-copy-id root@worker2
ssh-copy-id root@lb1
ssh-copy-id root@lb2
```

## HAProxy+Keepalived

> masterèŠ‚ç‚¹çš„é«˜å¯ç”¨ï¼Œä¸¤ä¸ªä¸»æœºéƒ½å¾—é…ç½®
> kubletã€kube-proxy é…ç½®ä¸­é™æ€æŒ‡å®šäº†æŸä¸ª kube-apiserver å®ä¾‹çš„ IPï¼Œå¦‚æœè¯¥å®ä¾‹æŒ‚æ‰å¯èƒ½æœåŠ¡å¼‚å¸¸

[è½¯ä»¶è´Ÿè½½å‡è¡¡é€‰é¡¹æŒ‡å—](https://github.com/kubernetes/kubeadm/blob/main/docs/ha-considerations.md#options-for-software-load-balancing)

```shell
yum -y install haproxy keepalived
```

```shell
#ä¿®æ”¹haproxyé…ç½®ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å®Œå…¨ç›¸åŒ
vi /etc/haproxy/haproxy.cfg

#æ·»åŠ ä¸‹é¢çš„é…ç½®
frontend apiserver
    bind *:6443
    mode tcp
    option tcplog
    default_backend apiserver

backend apiserver
    option httpchk GET /healthz
    http-check expect status 200
    mode tcp
    option ssl-hello-chk
    balance     roundrobin
    server  master1 10.0.0.11:6443 check
    server  master2 10.0.0.12:6443 check
    server  master3 10.0.0.13:6443 check

#ä¸¤ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ
systemctl enable haproxy
systemctl start haproxy
```

```shell
#åœ¨lb1ä¿®æ”¹keepalivedé…ç½®
vi /etc/keepalived/keepalived.conf

#æ–°å¢ä¸‹é¢é…ç½®
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5
    weight -5
    fall 2
    rise 1
}

#ä¿®æ”¹ä¸‹é¢é…ç½®
vrrp_instance VI_1 {
    state MASTER #ä¸»èŠ‚ç‚¹ï¼Œlb2æ”¹ä¸ºå¤‡èŠ‚ç‚¹BACKUP
    interface ens33 #æ”¹ç½‘å¡
    virtual_router_id 51 #ä¸¤ä¸ªèŠ‚ç‚¹ç›¸åŒ
    priority 99 #æ’åºï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¸èƒ½ç›¸åŒ
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.0.100  #è™šæ‹ŸIPï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¸èƒ½ç›¸åŒ
    }
    track_script {
       chk_apiserver
    }
}


vi /etc/keepalived/check_apiserver.sh

#!/bin/bash

err=0
for k in $(seq 1 3)
do
    check_code=$(pgrep haproxy)
    if [[ $check_code == "" ]]; then
        err=$(expr $err + 1)
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ $err != "0" ]]; then
    echo "systemctl stop keepalived"
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi

chmod +x /etc/keepalived/check_apiserver.sh

#ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶scpä¼ ç»™lb2ï¼Œç„¶åä¿®æ”¹lb2çš„keepalived.conf

#ä¸¤ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œ
systemctl enable keepalived
systemctl start keepalived
```

éªŒè¯ï¼š`ip addr`ä¸€ä¸ªå¯ä»¥çœ‹åˆ° VIP ä¸€ä¸ªçœ‹ä¸åˆ°
[https://10.0.0.100:6443/healthz](https://10.0.0.100:6443/healthz) è¿™ä¸ªé“¾æ¥å¯ä»¥è®¿é—®äº†ï¼Œè¿™ä¹Ÿæ˜¯ kubeadm åˆå§‹åŒ– k8s é›†ç¾¤éœ€è¦æµ‹è¯•çš„é“¾æ¥

## kubeadméƒ¨ç½²K8Sé›†ç¾¤v1.21

### è½¯ä»¶å®‰è£…

> æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹å®‰è£…ï¼Œè´Ÿè½½å‡è¡¡èŠ‚ç‚¹ä¸ç”¨å®‰è£…

```shell
#å‡†å¤‡YUMæºï¼Œå‰åä½¿ç”¨yum repolistéªŒè¯
vi /etc/yum.repos.d/k8s.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg

#è½¯ä»¶å®‰è£…
#kubeadm åˆå§‹åŒ–é›†ç¾¤ã€ç®¡ç†é›†ç¾¤
yum -y install kubeadm-1.21.0 kubelet-1.21.0 kubectl-1.21.0
kubeadm version
kubectl version
systemctl enable kubelet

#é…ç½®kubeletï¼Œä¸ºäº†å®ç°dockerä½¿ç”¨çš„cgroupdriverä¸kubeletä½¿ç”¨çš„cgroupçš„ä¸€è‡´æ€§
vi /etc/sysconfig/kubelet
KUBELET_EXTRA_ARGS="--cgroup-driver=systemd"
```

### ä¸‹è½½é•œåƒ

> æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹å®‰è£…ï¼Œè´Ÿè½½å‡è¡¡èŠ‚ç‚¹ä¸ç”¨å®‰è£…

```shell
#æŸ¥çœ‹è¿œç¨‹é•œåƒåˆ—è¡¨ï¼Œä½¿ç”¨kubeadm versionæŸ¥åˆ°çš„ç‰ˆæœ¬å·
kubeadm config images list --kubernetes-version=v1.21.0

#ä»é˜¿é‡Œäº‘ä¸‹è½½é•œåƒ
docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.21.0
docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.21.0
docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.21.0
docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.21.0
docker pull registry.aliyuncs.com/google_containers/pause:3.4.1
docker pull registry.aliyuncs.com/google_containers/etcd:3.4.13-0
docker pull registry.aliyuncs.com/google_containers/coredns:v1.8.0
```

### é›†ç¾¤åˆå§‹åŒ–

```shell
#åœ¨master1åˆå§‹åŒ–é›†ç¾¤
kubeadm init \
  --apiserver-advertise-address=10.0.0.11 \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.21.0 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=10.244.0.0/16 \
  --control-plane-endpoint 10.0.0.100 --upload-certs \
  --ignore-preflight-errors=all

#æŸ¥çœ‹è¾“å‡ºä¸­æœ€åçš„å‡ ä¸ªå‘½ä»¤å¹¶æ‰§è¡Œ

#æŸ¥çœ‹å·²ç»å¯åŠ¨çš„é›†ç¾¤èŠ‚ç‚¹
kubectl get nodes

#é‡æ–°ç”Ÿæˆtokenï¼Œè¾“å‡ºçš„å‘½ä»¤æ˜¯xxx
kubeadm token create --print-join-command
#ç”Ÿæˆè¯ä¹¦ç”¨äºæ–°masteråŠ å…¥é›†ç¾¤ï¼Œè¾“å‡ºçš„è¯ä¹¦æ˜¯yyy
kubeadm init phase upload-certs --upload-certs
#æ–°masteråŠ å…¥é›†ç¾¤
xxx --control-plane --certificate-key yyy
#æ–°workeråŠ å…¥é›†ç¾¤
xxx
```

![](81e401645c89b8c41f16db79a37180e1.png)

### é›†ç¾¤ç½‘ç»œå‡†å¤‡

> åªåœ¨master1åšå°±å¯ä»¥äº†ï¼Œä½¿ç”¨ Calico

[å®˜ç½‘](https://docs.tigera.io/archive/v3.22/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-50-nodes-or-less)

å®‰è£… calico

```shell
#æ³¨æ„K8Sä¸calicoæ’ä»¶å’Œå…¼å®¹ç‰ˆæœ¬
curl https://projectcalico.docs.tigera.io/archive/v3.22/manifests/calico.yaml -O

#æ”¹ä¸ºä½¿ç”¨é›†ç¾¤åˆå§‹åŒ–æ—¶podçš„CIDR
- name: CALICO_IPV4POOL_CIDR
  value: "10.244.0.0/16"

kubectl apply -f calico.yaml
#ç›´æ¥æ‰§è¡Œå¯èƒ½éƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥å…ˆä¸‹è½½é•œåƒå†æ‰§è¡Œ
#å¦‚æœéƒ¨ç½²å¤±è´¥éœ€è¦é‡æ–°éƒ¨ç½²å¯ä»¥å°†applyæ”¹ä¸ºdeleteå…ˆæ‰§è¡Œä¸€é
docker pull docker.io/calico/cni:v3.22.5
docker pull docker.io/calico/pod2daemon-flexvol:v3.22.5
docker pull docker.io/calico/node:v3.22.5
docker pull docker.io/calico/kube-controllers:v3.22.5

#å®‰è£…æˆåŠŸçœ‹ä¸‹é¢å›¾ç‰‡
```

![zoom=65](24089f38a2a5406f56f435ac316a87c4.png)

![zoom=60](515e7c11be31fc6b23baed57f144f9a0.png)

![zoom=60](25e17bc47a224bd333c61da65df3d244.png)

[kubectl get cs ç»„ä»¶ä¸å¥åº·çš„è§£å†³åŠæ³•](https://www.cnblogs.com/xhg-Cathy/p/15714949.html)

å®‰è£… calicoctl

```shell
wget https://github.com/projectcalico/calico/releases/download/v3.22.5/calicoctl-linux-amd64

mv calicoctl-linux-amd64 /usr/bin/calicoctl
chmod +x /usr/bin/calicoctl

calicoctl version
```

## å®‰è£…kuboard

```shell
docker run -d \
  --restart=always \
  --name=kuboard \
  -p 81:80/tcp \
  -p 10081:10081/tcp \
  -e KUBOARD_ENDPOINT="http://10.0.0.18:81" \
  -e KUBOARD_AGENT_SERVER_TCP_PORT="10081" \
  -v /root/kuboard-data:/data \
  eipwork/kuboard:v3
```

# ğŸ¥‡é¢è¯•é¢˜

## K8Så’ŒDockerçš„å…³ç³»

Docker ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå°†åº”ç”¨ç¨‹åºè¿è¡Œæ‰€éœ€çš„è®¾ç½®å’Œä¾èµ–é¡¹æ‰“åŒ…åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä»è€Œå®ç°äº†å¯ç§»æ¤æ€§
K8S ç”¨äºå…³è”å’Œç¼–æ’åœ¨å¤šä¸ªä¸»æœºä¸Šè¿è¡Œçš„å®¹å™¨

## K8Sé›†ç¾¤

### éƒ¨ç½²æ–¹å¼

kubeadmï¼šä¹Ÿæ˜¯æ¨èçš„ä¸€ç§éƒ¨ç½²æ–¹å¼
äºŒè¿›åˆ¶ï¼šè¾ƒæ·±å…¥çš„éƒ¨ç½²æ–¹å¼ï¼Œä½†æ˜¯æ¯”è¾ƒéº»çƒ¦
sealosï¼šæé€Ÿéƒ¨ç½²ï¼Œå°è£…äº† kubeadm

### å¦‚ä½•æ·»åŠ èŠ‚ç‚¹å’Œåˆ é™¤èŠ‚ç‚¹

æ·»åŠ èŠ‚ç‚¹ï¼š

```shell
#å…ˆæŸ¥çœ‹æœ‰æ²¡æœ‰æœ‰æ•ˆçš„token
kubeadm token list

#æ²¡æœ‰tokenå°±åˆ›å»ºä¸€ä¸ª
kubeadm token create --print-join-command

#å°†æ–°èŠ‚ç‚¹åŠ å…¥
kubeadm join 10.0.0.100:6443 --token d8q8he.ormit5mgteofldmc --discovery-token-ca-cert-hash sha256:1959a43f007ffef5e2f078245b05be5f71d53fd31b831656f3312254bf24ea54
```

åˆ é™¤èŠ‚ç‚¹ï¼š

å…ˆä½¿ç”¨`kubectl drain`å°†è¯¥èŠ‚ç‚¹çš„ Pod è¿›è¡Œé©±é€ï¼Œå†ç”¨`kubectl delete node xx`ç§»é™¤æ­¤èŠ‚ç‚¹

# 发送短信验证码

1、调用【第三方接入服务】发送短信成功，短信内容为随机验证码
2、然后把【验证码+当前时间】作为 value，【固定前缀+手机号】作为 key 存入 redis，过期时间是5分钟

**为了防止恶意流量，设计的是1分钟内不允许重复发送短信**

发短信前，根据手机号从 redis 取出 value，如果有且解析得到的【当前时间】与当前时间差小于一分钟，就提示用户短信发送过于频繁稍后再试

# 注册流程

1. 校验提交信息的合法性，比如空值判断
2. 校验验证码（如果验证成功就从 redis 删除）
3. 校验用户名和手机号是否重复
4. 加密密码后，插入数据库
5. 返回成功

# 用户登录

分布式会话可以考虑的方案：分布式session 和 Token

## 分布式session

- 使用 redis 实现 session 共享
- 用 session 必须 cookie 配合，浏览器支持 cookie，但原生APP不支持，而用 Token 更加简单

## Token有两种方案

### 服务端不存Token

不存就必须给 Token 设置过期时间

【典型例子】就是 JWT，即 json web token，JWT 分为三个部分：

1. 第一部分是算法本身转化的 Base64 字符串
2. 第二部分是用户信息转化的 Base64 字符串
3. 第三部分是使用算法和盐对前两个部分的加密（无法逆向破解的算法）

【安全性】别人不知道我的算法和盐就无法伪造正确的 Token

【优点】服务端免去了存储 Token 的负担，而且解析 Token 比查共享存储验证权限速度快

【缺点】不能及时关闭对用户的授权，只能依赖于 Token 过期；用户 Token 被盗就麻烦了
【解决方案】就是添加 Token 黑名单，但这依赖于共享存储，违背了不存的初衷，因此不合适

因此不存 Token 适用于对安全性要求不高的场景

### 服务端存Token

想关闭授权删除用户的 Token 即可，用户需要重新登录才能取得授权

**共享存储的选择**

不推荐用数据库性能较低，可以使用高可用的 Redis 集群

**Redis宕机？**

宕机是偶发现象，而且即使宕机造成部分 Token 丢失影响的用户量也不会很大，完全可以接受

**双 Token 提升用户体验**

一旦 Token 到期从 Redis 中删除，用户就得重新登录，这样会影响用户体验

每次请求都更新 Token？如果请求断了没收到响应，用户就得重新登录

我优化的方案是使用双 Token，用户登录成功之后下发双 Token：accessToken 和 refreshToken

- accessToken 用于接口调用
- refreshToken 用于 Token 刷新：如果调用接口发现 accessToken 过期，就调用刷新 Token 接口得到新的双 Token，再利用新的 accessToken 再次调用原接口，因此 refreshToken 过期时间比 accessToken 长一些

**关闭授权**

同时删除双 Token 即可

**另外为了用户安全，防止暴力破解**

如果密码 or 验证码多次校验失败，当天禁止用户登录，利用 Redis 计数器实现

**密码安全**

散列算法不可逆不会被逆向破解，对称加密和非对称加密可以被逆向破解
因为密码没有解密的需求，因此使用散列算法，更加安全